<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="_csrf" th:content="${_csrf.token}"/><meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Gestión de Usuarios - Biblioteca</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>body{background:#f8f9fa}.user-info{color:#f8f9fa}</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/">Biblioteca</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item" sec:authorize="hasAuthority('ROLE_ADMIN')"><a class="nav-link" href="/usuarios">Usuarios</a></li>
        <li class="nav-item"><a class="nav-link" href="/libros">Libros</a></li>
        <li class="nav-item"><a class="nav-link" href="/prestamos">Préstamos</a></li>
        <li class="nav-item" sec:authorize="hasAuthority('ROLE_ADMIN')"><a class="nav-link" href="/consulta-usuarios">Consulta</a></li>
        <li class="nav-item"><span class="user-info">Usuario: <span sec:authentication="name">Usuario</span> <span sec:authorize="hasAuthority('ROLE_ADMIN')">(ADMIN)</span><span sec:authorize="hasAuthority('ROLE_CLIENTE')">(CLIENTE)</span></span></li>
        <li class="nav-item"><form th:action="@{/logout}" method="post" style="display:inline"><button type="submit" class="btn btn-outline-light btn-sm ms-2">Salir</button></form></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Gestión de Usuarios</h4>
    <button id="btnRefresh" class="btn btn-success btn-sm">Actualizar</button>
  </div>
  <div class="card mb-3" sec:authorize="hasAuthority('ROLE_ADMIN')">
    <div class="card-body">
      <form id="usuarioForm" class="row g-2">
        <input type="hidden" id="usuarioId">
        <div class="col-12 col-md-6"><input id="identificacion" class="form-control" placeholder="Identificación" maxlength="20" required></div>
        <div class="col-12 col-md-6"><input id="telefonoMovil" class="form-control" placeholder="Teléfono móvil" maxlength="15" required></div>
        <div class="col-12 col-md-6"><input id="nombreCompleto" class="form-control" placeholder="Nombre completo" maxlength="80" required></div>
        <div class="col-12 col-md-6"><input id="correoElectronico" class="form-control" placeholder="Correo electrónico" maxlength="100" type="email" required></div>
        <div class="col-12 text-end mt-1">
          <button type="submit" id="submitBtn" class="btn btn-primary btn-sm" title="Guardar"><i class="bi bi-save"></i><span id="submitText" class="visually-hidden">Crear Usuario</span></button>
          <button type="button" id="cancelBtn" class="btn btn-secondary btn-sm" style="display:none">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Lista de Usuarios</strong>
      <button id="btnLoad" class="btn btn-success btn-sm">Cargar</button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light"><tr><th>ID</th><th>Identificación</th><th>Nombre</th><th>Teléfono</th><th>Correo</th><th>Acciones</th></tr></thead>
          <tbody id="usuariosTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
      <span class="text-muted small" id="pageInfo">Mostrando 0 de 0</span>
      <div>
        <button id="prevBtn" class="btn btn-sm btn-outline-secondary" disabled>Anterior</button>
        <span class="mx-2" id="pageNum">Página 1</span>
        <button id="nextBtn" class="btn btn-sm btn-outline-secondary" disabled>Siguiente</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Confirmar Eliminación</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">¿Está seguro que desea eliminar este usuario?</div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button><button id="confirmDelete" class="btn btn-danger btn-sm">Eliminar</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
const $ = id => document.getElementById(id);
let delId = null, editing = false, allUsers = [], page = 1, perPage = 10;
const isAdmin = /*[[${#authorization.expression('hasAuthority(''ROLE_ADMIN'')')}]]*/ false;

function csrf() {
  const t = document.querySelector('meta[name="_csrf"]'), h = document.querySelector('meta[name="_csrf_header"]');
  return t && h ? { token: t.content, header: h.content } : null;
}

async function fetch$(url, opts = {}) {
  const c = csrf();
  if (c && opts.method && opts.method !== 'GET') (opts.headers = opts.headers || {})[c.header] = c.token;
  return fetch(url, opts);
}

async function load() {
  try {
    const r = await fetch('/api/usuarios'); if (!r.ok) throw r;
    allUsers = await r.json(); page = 1; render();
  } catch (e) { console.error(e); $('usuariosTableBody').innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">Error cargando usuarios</td></tr>'; alert('Error al cargar usuarios'); }
}

function render() {
  const start = (page - 1) * perPage, end = start + perPage, pageData = allUsers.slice(start, end);
  const total = allUsers.length, totalPages = Math.ceil(total / perPage);
  $('usuariosTableBody').innerHTML = pageData.length ? pageData.map(u => `<tr data-id="${u.id}"><td>${u.id}</td><td>${u.identificacion}</td><td>${esc(u.nombreCompleto)}</td><td>${esc(u.telefonoMovil)}</td><td>${esc(u.correoElectronico)}</td><td>${isAdmin ? `<button class="btn btn-warning btn-sm" data-act="edit" title="Editar"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-danger btn-sm" data-act="del" title="Eliminar"><i class="bi bi-trash"></i></button>` : ''}</td></tr>`).join('') : '<tr><td colspan="6" class="text-center py-3">No hay usuarios</td></tr>';
  $('pageInfo').textContent = total ? `Mostrando ${start + 1}-${Math.min(end, total)} de ${total}` : 'Mostrando 0 de 0';
  $('pageNum').textContent = `Página ${page} de ${totalPages || 1}`;
  $('prevBtn').disabled = page <= 1; $('nextBtn').disabled = page >= totalPages;
}

async function save(e) {
  e.preventDefault();
  const data = { identificacion: $('identificacion').value.trim(), telefonoMovil: $('telefonoMovil').value.trim(), nombreCompleto: $('nombreCompleto').value.trim(), correoElectronico: $('correoElectronico').value.trim() };
  if (!data.identificacion || !data.nombreCompleto || !data.correoElectronico) return alert('Complete los campos obligatorios');
  const id = $('usuarioId').value;
  try {
    const opts = { headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) };
    const res = editing && id ? await fetch$(`/api/usuarios/${id}`, { ...opts, method: 'PUT' }) : await fetch$('/api/usuarios', { ...opts, method: 'POST' });
    if (res.ok) { alert(editing ? 'Usuario actualizado' : 'Usuario creado'); reset(); load(); }
    else if (res.status === 409) alert('Ya existe un usuario con esa identificación');
    else alert('Error al guardar usuario');
  } catch (err) { console.error(err); alert('Error al guardar usuario'); }
}

function click(e) {
  const btn = e.target.closest('button[data-act]'); if (!btn) return;
  const act = btn.dataset.act, id = btn.closest('tr')?.dataset?.id; if (!id) return;
  if (act === 'edit') edit(id);
  else if (act === 'del') { delId = id; new bootstrap.Modal($('deleteModal')).show(); }
}

async function edit(id) {
  try {
    const r = await fetch(`/api/usuarios/${id}`); const u = await r.json();
    $('usuarioId').value = u.id; $('identificacion').value = u.identificacion; $('telefonoMovil').value = u.telefonoMovil;
    $('nombreCompleto').value = u.nombreCompleto; $('correoElectronico').value = u.correoElectronico;
    editing = true; $('submitText').textContent = 'Actualizar Usuario'; $('cancelBtn').style.display = 'inline-block'; $('identificacion').focus();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (e) { console.error(e); alert('Error al cargar usuario'); }
}

function reset() { editing = false; $('usuarioForm').reset(); $('usuarioId').value = ''; $('submitText').textContent = 'Crear Usuario'; $('cancelBtn').style.display = 'none'; }

async function del() {
  if (!delId) return;
  try {
    const r = await fetch$(`/api/usuarios/${delId}`, { method: 'DELETE' });
    if (r.ok) { alert('Usuario eliminado'); load(); } else alert('Error al eliminar usuario');
  } catch (e) { console.error(e); alert('Error al eliminar usuario'); }
  delId = null; bootstrap.Modal.getInstance($('deleteModal')).hide();
}

function esc(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

document.addEventListener('DOMContentLoaded', () => {
  load();
  $('usuarioForm').addEventListener('submit', save);
  $('cancelBtn').addEventListener('click', reset);
  $('usuariosTableBody').addEventListener('click', click);
  $('confirmDelete').addEventListener('click', del);
  $('btnLoad').addEventListener('click', load);
  $('btnRefresh').addEventListener('click', load);
  $('prevBtn').addEventListener('click', () => { if (page > 1) { page--; render(); } });
  $('nextBtn').addEventListener('click', () => { if (page < Math.ceil(allUsers.length / perPage)) { page++; render(); } });
});
</script>
</body>
</html>
