<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="_csrf" th:content="${_csrf.token}"/><meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Gestión de Libros - Biblioteca</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body{background:#f5f7fa}.user-info{color:#f8f9fa}
    .highlight{animation:highlightAnim 2s ease;background:#fff3cd}
    @keyframes highlightAnim{from{background:#fff3cd}to{background:transparent}}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/">Biblioteca</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item" sec:authorize="hasAuthority('ROLE_ADMIN')"><a class="nav-link" href="/usuarios">Usuarios</a></li>
        <li class="nav-item"><a class="nav-link" href="/libros">Libros</a></li>
        <li class="nav-item"><a class="nav-link" href="/prestamos">Préstamos</a></li>
        <li class="nav-item" sec:authorize="hasAuthority('ROLE_ADMIN')"><a class="nav-link" href="/consulta-usuarios">Consulta</a></li>
        <li class="nav-item"><span class="user-info">Usuario: <span sec:authentication="name">Usuario</span> <span sec:authorize="hasAuthority('ROLE_ADMIN')">(ADMIN)</span><span sec:authorize="hasAuthority('ROLE_CLIENTE')">(CLIENTE)</span></span></li>
        <li class="nav-item"><form th:action="@{/logout}" method="post" style="display:inline"><button type="submit" class="btn btn-outline-light btn-sm ms-2">Salir</button></form></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Gestión de Libros</h4>
    <button id="btnActualizar" class="btn btn-outline-primary btn-sm">Actualizar</button>
  </div>

  <div class="card mb-3" sec:authorize="hasAuthority('ROLE_ADMIN')">
    <div class="card-body">
      <form id="libroForm" class="row g-2">
        <input type="hidden" id="libroId">
        <div class="col-12 col-md-6"><input id="isbn" class="form-control" placeholder="ISBN" maxlength="50" required></div>
        <div class="col-12 col-md-6"><input id="titulo" class="form-control" placeholder="Título" maxlength="100" required></div>
        <div class="col-12 col-md-6"><input id="autor" class="form-control" placeholder="Autor" maxlength="100" required></div>
        <div class="col-12 col-md-6"><input id="editorial" class="form-control" placeholder="Editorial" maxlength="50" required></div>
        <div class="col-6 col-md-3"><input id="anio" type="number" class="form-control" placeholder="Año" min="1000" max="2099"></div>
        <div class="col-6 col-md-3"><input id="edicion" class="form-control" placeholder="Edición" maxlength="30"></div>
        <div class="col-12 text-end mt-1">
          <button type="submit" id="submitBtn" class="btn btn-primary btn-sm" title="Guardar"><i class="bi bi-save"></i><span id="submitText" class="visually-hidden">Crear Libro</span></button>
          <button type="button" id="cancelBtn" class="btn btn-secondary btn-sm" style="display:none" onclick="cancelar()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-3 p-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-8">
        <div class="input-group">
          <span class="input-group-text">🔎</span>
          <input id="buscarTitulo" list="sugerencias" class="form-control" placeholder="Escribe título">
          <datalist id="sugerencias"></datalist>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <button id="btnBuscar" class="btn btn-primary btn-sm me-2">Buscar</button>
        <button id="btnLimpiar" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light"><tr><th>ID</th><th>ISBN</th><th>Título</th><th>Autor</th><th>Año</th><th>Edición</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="librosTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
      <span class="text-muted small" id="pageInfo">Mostrando 0 de 0</span>
      <div>
        <button id="prevBtn" class="btn btn-sm btn-outline-secondary" disabled>Anterior</button>
        <span class="mx-2" id="pageNum">Página 1</span>
        <button id="nextBtn" class="btn btn-sm btn-outline-secondary" disabled>Siguiente</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Confirmar Eliminación</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">¿Está seguro de que desea eliminar este libro?</div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button><button id="confirmDelete" class="btn btn-danger btn-sm">Eliminar</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
const $ = id => document.getElementById(id);
let delId = null, editing = false, disp = [], prest = [], todos = [], filtered = [], page = 1, perPage = 10;
const isAdmin = /*[[${#authorization.expression('hasAuthority(''ROLE_ADMIN'')')}]]*/ false;

function csrf() { const t = document.querySelector('meta[name="_csrf"]'), h = document.querySelector('meta[name="_csrf_header"]'); return t && h ? { token: t.content, header: h.content } : null; }
async function fetch$(url, opts = {}) { const c = csrf(); if (c && opts.method && opts.method !== 'GET') (opts.headers = opts.headers || {})[c.header] = c.token; return fetch(url, opts); }
function esc(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

async function load() {
  try { const r = await fetch('/api/libros'); if (!r.ok) throw r; todos = await r.json(); filtered = todos; page = 1; render(); suggest(todos); }
  catch (e) { console.error('load', e); }
}

async function loadStatus() {
  try { const [d, p] = await Promise.all([fetch('/api/libros/disponibles'), fetch('/api/libros/prestados')]); disp = await d.json(); prest = await p.json(); }
  catch (e) { console.error('loadStatus', e); }
}

function suggest(list) {
  const data = $('sugerencias'); data.innerHTML = '';
  Array.from(new Set(list.map(l => l.titulo).filter(Boolean))).forEach(t => { const opt = document.createElement('option'); opt.value = t; data.appendChild(opt); });
}

function render(scroll = false) {
  const start = (page - 1) * perPage, end = start + perPage, pageData = filtered.slice(start, end);
  const total = filtered.length, totalPages = Math.ceil(total / perPage);
  const tbody = $('librosTableBody'); tbody.innerHTML = '';
  pageData.forEach(libro => {
    const isD = disp.some(l => l.id === libro.id), isP = prest.some(l => l.id === libro.id);
    const estado = isP ? '<span class="badge bg-warning">Prestado</span>' : isD ? '<span class="badge bg-success">Disponible</span>' : '<span class="badge bg-secondary">Sin determinar</span>';
    const tr = document.createElement('tr'); tr.dataset.titulo = (libro.titulo || '').toLowerCase();
    const btns = isAdmin ? `<button class="btn btn-warning btn-sm" onclick="edit(${libro.id})" title="Editar"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-danger btn-sm" onclick="del(${libro.id})" title="Eliminar"><i class="bi bi-trash"></i></button>` : '';
    tr.innerHTML = `<td>${libro.id}</td><td>${libro.isbn}</td><td>${libro.titulo}</td><td>${libro.autor}</td><td>${libro.anio || '-'}</td><td>${libro.edicion || '-'}</td><td>${estado}</td><td>${btns} <button class="btn btn-info btn-sm" onclick="check(${libro.id})" title="Ver disponibilidad"><i class="bi bi-eye"></i></button></td>`;
    tbody.appendChild(tr);
  });
  $('pageInfo').textContent = total ? `Mostrando ${start + 1}-${Math.min(end, total)} de ${total}` : 'Mostrando 0 de 0';
  $('pageNum').textContent = `Página ${page} de ${totalPages || 1}`;
  $('prevBtn').disabled = page <= 1; $('nextBtn').disabled = page >= totalPages;
  if (scroll && pageData.length) {
    requestAnimationFrame(() => {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      if (rows[0]) { rows[0].scrollIntoView({ behavior: 'smooth', block: 'center' }); rows[0].classList.add('highlight'); setTimeout(() => rows[0].classList.remove('highlight'), 2000); }
    });
  }
}

function filter(text, scroll = false) {
  const q = (text || '').trim().toLowerCase();
  filtered = q ? todos.filter(l => (l.titulo || '').toLowerCase().includes(q)) : todos;
  page = 1; render(scroll);
}

async function edit(id) {
  try {
    const r = await fetch(`/api/libros/${id}`); const libro = await r.json();
    $('libroId').value = libro.id; $('isbn').value = libro.isbn; $('titulo').value = libro.titulo; $('autor').value = libro.autor; $('editorial').value = libro.editorial;
    $('anio').value = libro.anio || ''; $('edicion').value = libro.edicion || ''; editing = true; $('submitText').textContent = 'Actualizar Libro'; $('cancelBtn').style.display = 'inline-block'; $('libroForm').scrollIntoView();
  } catch (e) { console.error(e); alert('Error al cargar los datos del libro'); }
}

function cancelar() { editing = false; $('libroForm').reset(); $('libroId').value = ''; $('submitText').textContent = 'Crear Libro'; $('cancelBtn').style.display = 'none'; }
function del(id) { delId = id; new bootstrap.Modal($('deleteModal')).show(); }

async function check(id) {
  try { const r = await fetch(`/api/prestamos/libro/${id}/disponible`); const disponible = await r.json(); alert(disponible ? 'El libro está disponible para préstamo' : 'El libro está actualmente prestado'); }
  catch (e) { console.error(e); alert('Error al verificar la disponibilidad del libro'); }
}

document.addEventListener('DOMContentLoaded', () => {
  load(); loadStatus();
  $('btnActualizar').onclick = load;
  $('btnBuscar').onclick = () => filter($('buscarTitulo').value, true);
  $('btnLimpiar').onclick = () => { $('buscarTitulo').value = ''; filter(''); };
  $('buscarTitulo').addEventListener('change', () => filter($('buscarTitulo').value, true));
  $('prevBtn').addEventListener('click', () => { if (page > 1) { page--; render(); } });
  $('nextBtn').addEventListener('click', () => { if (page < Math.ceil(filtered.length / perPage)) { page++; render(); } });
});

$('libroForm').addEventListener('submit', async e => {
  e.preventDefault();
  const libro = { isbn: $('isbn').value, titulo: $('titulo').value, autor: $('autor').value, editorial: $('editorial').value, anio: $('anio').value ? parseInt($('anio').value) : null, edicion: $('edicion').value || null };
  const libroId = $('libroId').value;
  try {
    const opts = { headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(libro) };
    const r = editing && libroId ? await fetch$(`/api/libros/${libroId}`, { ...opts, method: 'PUT' }) : await fetch$('/api/libros', { ...opts, method: 'POST' });
    if (r.ok) { alert(editing ? 'Libro actualizado exitosamente' : 'Libro creado exitosamente'); $('libroForm').reset(); cancelar(); load(); loadStatus(); }
    else if (r.status === 409) alert('Ya existe un libro con ese ISBN'); else alert('Error al guardar el libro');
  } catch (err) { console.error(err); alert('Error al guardar el libro'); }
});

$('confirmDelete').addEventListener('click', async () => {
  if (!delId) return;
  try { const r = await fetch$(`/api/libros/${delId}`, { method: 'DELETE' }); if (r.ok) { alert('Libro eliminado exitosamente'); load(); loadStatus(); } else alert('Error al eliminar el libro'); }
  catch (e) { console.error(e); alert('Error al eliminar el libro'); }
  delId = null; bootstrap.Modal.getInstance($('deleteModal')).hide();
});
</script>
</body>
</html>
